<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Barentswatch FiskInfo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript" defer="defer" src="OpenLayers.js"></script>
    <script>
        var map;
        var ls;
        var mFeature;
        var selectFeature;
        var geoJson = null;
        var token = null;
        var sensor = false;
        var format = "image/jpeg";
        var highlightVesselName = null;
        window.onload = function () {
            init();
        }
        var init = function () {
            // create map
            map = new OpenLayers.Map({
                div: "map",
                theme: null,
                projection: 'EPSG:3857',
                controls: [
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.TouchNavigation({
                        dragPanOptions: {
                            enableKinetic: true
                        }
                    }),
                    new OpenLayers.Control.Zoom()
                ],
                layers: [
                    new OpenLayers.Layer.WMS(
	      		"Grunnkart", "http://opencache.statkart.no/gatekeeper/gk/gk.open?",
		      	{ layers: 'sjokartraster', format: 'image/png' },
                        { 'displayInLayerSwitcher': false }, {
                            isBaseLayer: true
                        }

	      	)
                ],
                center: new OpenLayers.LonLat(15, 66.5).transform(new OpenLayers.Projection('EPSG:4326'), new OpenLayers.Projection('EPSG:3857')),
                zoom: 5
            });
        };

        function populateMap(authenticated) {
            map.addLayers(populateAllAvailableWmsLayers());
            populateAndStyleToolsLayer();
            populateAndStyleIceChartLayer();
            populateLayers();

            if(authenticated === 1) {
                var toolLayer = map.getLayersByName("Redskap")[0];
                selectFeature = new OpenLayers.Control.SelectFeature(
                toolLayer, {
                    onSelect: toolClickNotice,
                    onUnselect: onPopupFeatureUnselect,
                    autoActivate: true
                });
                map.addControl(selectFeature);
            }

            toggleAllLayersInvisible();
        }

        function Container(name, isVisible) {
            this.name = name;
            this.isVisible = isVisible;
        }

        function populateLayers() {
            var layerArray = getLayers();

            var geoJsonFormat = new OpenLayers.Format.GeoJSON({
                'internalProjection': new OpenLayers.Projection("EPSG:3857"),
                'externalProjection': new OpenLayers.Projection("EPSG:4326")
            });

            for (var i = 0; i < layerArray.length; i++) {
                if(layerArray[i] === "Grunnkart") {
                    continue;
                } else if(layerArray[i] === "Redskap") {
                    continue;
                }

                var features = getJsonFile(layerArray[i].replace(",", "").replace(" ", "_"));

                if(features != null) {
                    map.getLayersByName(layerArray[i])[0].addFeatures(geoJsonFormat.read(features));
                } else {

                }
            }
        }

        function getLayersAndState() {
            var retval = [];
            var layerArray = getLayers();
            for (var i = 0; i < layerArray.length; i++) {
                if (getLayerVisibilityByName(layerArray[i])) {
                    var c = new Container(layerArray[i], true);
                    retval.push(c);
                } else {
                    var co = new Container(layerArray[i], false);
                    retval.push(co);
                }
            }
            message = JSON.stringify(retval);
            Android.setMessage(message);
        }

        function toggleLayers(layers) {
            toggleAllLayersInvisible();
            for (var i = 0; i < layers.length; i++) {
                toggleLayerVisibilityByName(layers[i], true);
            }
        }

        function corsErrBack(error) {
            var i = 5;
            alert(error);
        }

        function getToken() {
            token = Android.getToken();
            return token;
        }

        function getJsonFile(fileName) {
            var jsonFile = Android.getGeoJSONFile(fileName);
            return JSON.parse(jsonFile);
        }

        function populateAndStyleToolsLayer() {
            var toolLayer;
            geoJson = getJsonFile("Redskap");

            var geoJsonFormat = new OpenLayers.Format.GeoJSON({
                'internalProjection': new OpenLayers.Projection("EPSG:3857"),
                'externalProjection': new OpenLayers.Projection("EPSG:4326")
            });

            var toolStyle = OpenLayers.Util.extend( {}, OpenLayers.Feature.Vector.style[ 'default' ] );

            toolStyle.strokeWidth = '${strokeWidth}';
            toolStyle.strokeColor = '${strokeColor}';
            toolStyle.fillColor = '${fillColor}';
            toolStyle.fill = true;
            toolStyle.pointRadius = '${pointRadius}';
            toolStyle.fillOpacity = 1;
            toolStyle.graphicName = "triangle";

            var toolsStyleLayer = new OpenLayers.Style( toolStyle, {
                context: {
                    strokeWidth: function(feature) {
                        if(feature.hasOwnProperty( 'geometry')) {
                            <!-- There is probably a better way of getting the tool type -->
                            var type = feature.geometry.toString().split("(")[0];
                            var retVal;
                            if(type.toLowerCase() === "LineString".toLowerCase()) {
                                retVal = map.getZoom() > 7 ? 10 : 1;
                            } else if(type.toLowerCase() === "Point".toLowerCase()) {
                                if (highlightVesselName != null && feature.hasOwnProperty("cluster")) {
                                    if (highlightVesselName === "Ukjent fartøy") {
                                        for (i = 0; i < feature.cluster.length; i++) {
                                            toolFeature = feature.cluster[i];
                                            if (toolFeature.attributes.vesselname === null) {
                                                return 3;
                                            }
                                        }
                                    } else {
                                        for (i = 0; i < feature.cluster.length; i++) {
                                            toolFeature = feature.cluster[i];
                                            if (toolFeature.attributes.vesselname === highlightVesselName) {
                                                return 3;
                                            }
                                        }
                                    }
                                } else {
                                    retVal = 1;
                                }
                            } else {
                                retVal = 4;
                            }
                            return retVal;
                        }
                    },
                    pointRadius: function(feature) {
                            var retVal;
                            if(feature.data.tooltypename != null) {
                                retVal = map.getZoom() > 6 ? 11 : 5;
                            } else {
                                retVal = 7;
                            }
                            return retVal;
                    },
                    strokeColor: function (feature) {
                        if (highlightVesselName != null) {
                            if (!feature.hasOwnProperty("cluster")) {
                                if (feature.attributes.vesselname === highlightVesselName || (highlightVesselName === "Ukjent fartøy" && feature.attributes.vesselname == null)) {
                                    return "#00FF00";
                                }
                            } else {
                                var toolFeature;

                                if (highlightVesselName === "Ukjent fartøy") {
                                    for (i = 0; i < feature.cluster.length; i++) {
                                        toolFeature = feature.cluster[i];
                                        if (toolFeature.attributes.vesselname === null) {
                                            return "#00FF00";
                                        }
                                    }
                                } else {
                                    for (i = 0; i < feature.cluster.length; i++) {
                                        toolFeature = feature.cluster[i];
                                        if (toolFeature.attributes.vesselname === highlightVesselName) {
                                            return "#00FF00";
                                        }
                                    }
                                }

                                return "#00007A";
                            }
                        }

                        if (!feature.hasOwnProperty("cluster")) {
                            var color = "#" + feature.attributes.toolcolor.substring(3, feature.attributes.toolcolor.length);

                            return color;
                        } else {
                            return "#00007A";
                        }
                    },
                    fillColor: function (feature) {
                        if (highlightVesselName != null) {
                            if (!feature.hasOwnProperty("cluster")) {
                                if (feature.attributes.vesselname === highlightVesselName || (highlightVesselName === "Ukjent fartøy" && feature.attributes.vesselname == null)) {
                                    return "#00FF00";
                                }
                            } else {
                                return "#00007A";
                            }
                        }

                        if (!feature.hasOwnProperty('cluster')) {
                            var color = "#" + feature.attributes.toolcolor.substring(3, feature.attributes.toolcolor.length);
                            return color;
                        } else {
                            return "#00007A";
                        }
                    }
                }
            });

            var toolsStyleMap = new OpenLayers.StyleMap({
                "default": toolsStyleLayer,
                "select": new OpenLayers.Style({
                    fill: true,
                    pointRadius: 8,
                    strokeWidth: 2,
                    fillColor: "#66ccff",
                    strokeColor: "#3399ff",
                    graphicZIndex: 2
                })
            });

            toolLayer = map.getLayersByName("Redskap")[0];
            toolLayer.styleMap = toolsStyleMap;
            toolLayer.addFeatures(geoJsonFormat.read(geoJson));
        }

        function populateAndStyleIceChartLayer(data) {
            geoJson = getJsonFile("Iskonsentrasjon");

            var geoJsonFormat = new OpenLayers.Format.GeoJSON({
                'internalProjection': new OpenLayers.Projection("EPSG:3857"),
                'externalProjection': new OpenLayers.Projection("EPSG:4326")
            });
            var toolStyle = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
            toolStyle.fillColor = '${fillColor}';
            toolStyle.fill = true;
            toolStyle.strokeWidth = 0
            toolStyle.fillOpacity = '${fillOpacity}';
            var toolsStyleLayer = new OpenLayers.Style(toolStyle, {
                context: {
                    fillColor: function (feature) {
                        if (feature.data.hasOwnProperty('icetype')) {
                            var color = null;
                            if (feature.data.icetype === "Close Drift Ice") {
                                color = "#fb9c45";
                            } else if (feature.data.icetype === "Very Close Drift Ice") {
                                color = "#ff4040";
                            } else if (feature.data.icetype === "Fast Ice") {
                                color = "#c3c5c7";
                            } else if (feature.data.icetype === "Open Drift Ice") {
                                color = "#ffff40";
                            } else if (feature.data.icetype === "Very Open Drift Ice") {
                                color = "#a5fdb8";
                            } else if (feature.data.icetype === "Open Water") {
                                color = "#b0d6ff";
                            } else {
                                color = "#000000";
                            }

                            return color;
                        } else {
                            return "#FFAA7A";
                        }
                    },
                    fillOpacity: function (feature) {
                        if (feature.data.hasOwnProperty('icetype')) {
                            var opacity = 0.2;
                            if (feature.data.icetype === "Close Drift Ice") {
                                opacity = 0.5;;
                            } else if (feature.data.icetype === "Very Close Drift Ice") {
                                opacity = 0.5;;
                            } else if (feature.data.icetype === "Fast Ice") {
                                color = 0.5;
                            } else if (feature.data.icetype === "Open Drift Ice") {
                                opacity = 0.5;;
                            } else if (feature.data.icetype === "Very Open Drift Ice") {
                                opacity = 0.5;;
                            } else if (feature.data.icetype === "Open Water") {
                                opacity = 0.5;
                            } else {
                                opacity = 0.5
                            }

                            return opacity;
                        } else {
                            return 0.5;
                        }
                    }
                }
            });
            var iceChartStyleMap = new OpenLayers.StyleMap({
                "default": toolsStyleLayer,
                "select": new OpenLayers.Style({
                    fill: true,
                    pointRadius: 8,
                    strokeWidth: 2,
                    fillColor: "#66ccff",
                    strokeColor: "#3399ff",
                    graphicZIndex: 2
                })
            });
            var iceChartLayer = map.getLayersByName("Iskonsentrasjon")[0];
            iceChartLayer.styleMap = iceChartStyleMap;
            iceChartLayer.addFeatures(geoJsonFormat.read(geoJson));
            selectFeature = new OpenLayers.Control.SelectFeature(
            iceChartLayer, {
                onSelect: iceChartClickNotice,
                onUnselect: onPopupFeatureUnselect,
                autoActivate: true
            });
            map.addControl(selectFeature);
        }

        function highlightTools(vesselName) {
            highlightVesselName = vesselName;
            var toolLayer = map.getLayersByName("Redskap")[0];
            toolLayer.redraw();
        }

        function getLayers() {
            var mLayers = map.layers;
            var retval = [];
            for (var a = 0; a < mLayers.length; a++) {
                retval.push(mLayers[a].name);
            };
            return retval;
        }

        function getLayerVisibilityByName(name) {
            var layer = map.getLayersByName(name)[0];
            return layer.visibility;
        }

        function toggleAllLayersInvisible() {
            var layers = getLayers();
            for (var i = 0; i < layers.length; i++) {
                if (layers[i] === "Grunnkart") {
                    continue;
                }
                toggleLayerVisibilityByName(layers[i], false);
            }
        }

        function toggleLayerVisibilityByName(name, visibility) {
            var layer = map.getLayersByName(name)[0];
            layer.setVisibility(visibility);
        }

        function populateAllAvailableWmsLayers() {
            var layers = [
                new OpenLayers.Layer.Vector("Iskant"),
                new OpenLayers.Layer.Vector("Havbunnsinstallasjoner"),
                new OpenLayers.Layer.Vector("Seismikk, pågående"),
                new OpenLayers.Layer.Vector("Seismikk, planlagt"),
                new OpenLayers.Layer.Vector("Iskonsentrasjon"),
                new OpenLayers.Layer.Vector("Redskap", {
                    strategies: [new OpenLayers.Strategy.Cluster({
                        distance: 15,
                        threshold: 2
                    })]
                })
            ];

            return layers;
        }

        function toolClickNotice(feature) {
            mFeature = feature;
            var vesselName;
            var phoneNumber;
            var toolDate;
            var toolType;
            var position;

            if(!(feature.data.vesselname == null && feature.data.vesselphone == null && feature.data.setupdatetime == null && feature.data.tooltypename == null)) {
                if (feature.data.vesselname != null) {
                    vesselName = "Fartøynavn: " + feature.data.vesselname;
                } else {
                    vesselName = "Fartøynavn: " + "Ikke tilgjengelig";
                }
                if (feature.data.vesselphone != null) {
                    phoneNumber = "Telefonnummer: " + feature.data.vesselphone;
                } else {
                    phoneNumber = "Telefonnummer: " + "Ikke tilgjengelig";
                }
                if (feature.data.setupdatetime != null) {
                    toolDate = "Redskapet ble satt: " + feature.data.setupdatetime.replace(/[^\d.:-]/g, ' ');
                } else {
                    toolDate = "Redskapet ble satt: " + "Ikke tilgjengelig";
                }
                if (feature.data.tooltypename != null) {
                    toolType = "Redskapstype: '" + feature.data.tooltypename + "'";
                } else {
                    toolType = "Redskapstype: " + "Ikke tilgjengelig";
                }
                if(feature.geometry != null) {
                    var wgs84 = feature.geometry.clone();
                    wgs84.transform("EPSG:900913", "EPSG:4326");
                    position = "Posisjon: " + wgs84.getBounds().getCenterLonLat().lat + ", " + wgs84.getBounds().getCenterLonLat().lon;
                } else {
                    position = "Posisjon: " + "Ikke tilgjengelig";
                }

                popup = new OpenLayers.Popup.FramedCloud("Redskapsinformasjon",
                feature.geometry.getBounds().getCenterLonLat(),
                    null, "<p>Redskapsinformasjon</p> <p> " + vesselName + "</p>" + "<p>" + phoneNumber + "</p>" + "<p>" + toolDate + "</p>" + "<p>" + toolType + "</p>" + "<p>" + position + "</p>" + "<p></p>", null, true, onPopupClose);
                popup.panMapIfOutOfView = true;
                popup.autoSize = true;
                feature.popup = popup;
                map.addPopup(popup);
            } else {

                popup = new OpenLayers.Popup.FramedCloud("Redskapsinformasjon",
                feature.geometry.getBounds().getCenterLonLat(),
                    null, "Dette er en gruppering av redskaper, zoom inn for å se detaljer om hvert redskap.", null, true, onPopupClose);
                popup.panMapIfOutOfView = true;
                popup.autoSize = true;
                feature.popup = popup;
                map.addPopup(popup);
            }
        }

        function iceChartClickNotice(feature) {
            mFeature = feature;
            var iceType;
            if (feature.data.hasOwnProperty("icetype")) {
                if (feature.data.icetype != null) {
                    var type = feature.data.icetype;
                    if (type === "Close Drift Ice") {
                        iceType = "Tett drivis";
                    } else if (type === "Very Close Drift Ice") {
                        iceType = "Veldig tett drivis";
                    } else if (type === "Fast Ice") {
                        iceType = "Fast is";
                    } else if (type === "Open Drift Ice") {
                        iceType = "Åpen drivis";
                    } else if (type === "Very Open Drift Ice") {
                        iceType = "Veldig åpen drivis";
                    } else if (type === "Open Water") {
                        iceType = "Åpent vann";
                    } else {
                        iceType = "Detaljer ikke tilgjengelig";
                    }
                } else {
                    iceType = "Detaljer ikke tilgjengelig";
                }
                popup = new OpenLayers.Popup.FramedCloud("Redskapsinformasjon",
                feature.geometry.getBounds().getCenterLonLat(),
                    null, iceType + "<p></p>", null, true, onPopupClose);
                popup.panMapIfOutOfView = true;
                popup.autoSize = true;
                feature.popup = popup;
                map.addPopup(popup);
            }
        }

        function onPopupFeatureUnselect(feature) {
            map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
        }

        function onPopupClose(evt) {
            selectFeature.unselect(mFeature);
        }

        function populateUserPosition(callback) {
            /*Based on W3C standards specification: http://dev.w3.org/geo/api/spec-source.html */
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(callback, fail, { timeout: 60000 });
                return true;
            } else {
                return false;
            }
        }


        function zoomToUserPosition() {
            sensor = populateUserPosition(function (position) {
                var userPosition = new OpenLayers.LonLat(position.coords.longitude, position.coords.latitude).transform(new OpenLayers.Projection('EPSG:4326'), new OpenLayers.Projection('EPSG:3857'));
                map.setCenter(userPosition, 14);
            });
        }

        function fail() {
            alert("Venligst sjekk om du har internettforbindelse");
        }

    </script>
    <style>
        html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        }

        @media only screen and (max-width: 600px) {
        html, body {
        height: 100%;
        }
        }

        p {
        margin: 0;
        }

        #map {
        width: 100%;
        position: relative;
        height: 100%;
        }

        .olControlAttribution {
        position: absolute;
        font-size: 10px;
        bottom: 0 !important;
        right: 0 !important;
        background: rgba(0,0,0,0.1);
        font-family: Arial;
        padding: 2px 4px;
        border-radius: 5px 0 0 0;
        }

        #Redskapsinformasjon_close {
        background-color: cornflowerblue;
        }

        #Redskapsinformasjon_close:before {
        content: "X";
        text-align: center;
        }

        #title, #tags, #shortdesc {
        display: none;
        }

        div.olControlZoom {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(255,255,255,0.4);
        border-radius: 4px;
        padding: 2px;
        }

        * {
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        div.olControlZoom a {
        display: block;
        margin: 1px;
        padding: 0;
        color: white;
        font-size: 28px;
        font-family: sans-serif;
        font-weight: bold;
        text-decoration: none;
        text-align: center;
        height: 32px;
        width: 32px;
        line-height: 28px;
        text-shadow: 0 0 3px rgba(0,0,0,0.8);
        background: #130085; /* fallback for IE - IE6 requires background shorthand*/
        background: rgba(0, 60, 136, 0.5);
        filter: alpha(opacity=80);
        }

        a.olControlZoomIn {
        border-radius: 4px 4px 0 0;
        }

        a.olControlZoomOut {
        border-radius: 0 0 4px 4px;
        }

        div.olControlZoom a:hover {
        background: #130085; /* fallback for IE */
        background: rgba(0, 60, 136, 0.7);
        filter: alpha(opacity=100);
        }

        @media only screen and (max-width: 600px) {
        div.olControlZoom a:hover {
        background: rgba(0, 60, 136, 0.5);
        }
        }

        div.olMapViewport {
        -ms-touch-action: none;
        }

        .olLayerGrid .olTileImage {
        -webkit-transition: opacity 0.2s linear;
        -moz-transition: opacity 0.2s linear;
        -o-transition: opacity 0.2s linear;
        transition: opacity 0.2s linear;
        }
        /* Turn on GPU support where available */
        .olTileImage {
        -webkit-transform: translateZ(0);
        -moz-transform: translateZ(0);
        -o-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        -moz-backface-visibility: hidden;
        -ms-backface-visibility: hidden;
        backface-visibility: hidden;
        -webkit-perspective: 1000;
        -moz-perspective: 1000;
        -ms-perspective: 1000;
        perspective: 1000;
        }
    </style>

</head>
<body>
<h1 id="title">FiskInfo test av redskapskartet</h1>
<div id="tags">
    mobile
</div>
<p id="shortdesc">
    FiskInfo Karttjeneste
</p>
<div id="map"></div>
</body>
</html>